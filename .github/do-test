#!/bin/sh
TARGET=$1
DIR=build-"$TARGET"
CONFIGURE=do-"$TARGET"-configure
shift

if [ -d /opt/picolibc-ci ]; then
    TOP=/opt/picolibc-ci
else
    TOP=/opt
fi
for p in "$TOP"/*/bin "$TOP"/*/models/*; do
    PATH="$p":$PATH
done

# We can't use both the analyzer and sanitizer because
# the analyzer is run after the sanitizer and generates a lot
# of false positives, so just use the sanitizer as it
# appears to find more relevant bugs at this point.

SANITIZER="-Dsanitize=undefined"

# Use traps with the sanitizer on msp430 as the handlers make many
# tests too large

case "$TARGET" in
    *msp430*)
	SANITIZER="$SANITIZER -Dsanitize-trap-on-error=true"
	;;
esac

# Disable the sanitizer when not using tinystdio as the stdio code is
# full of problems

case "$*" in
    *-Dtinystdio=false*)
	SANITIZER=""
	;;
esac

mkdir "$DIR"
(cd "$DIR" || exit 1
 echo '##################################################'
 echo '##########' ../scripts/"$CONFIGURE" -Dwerror=true $SANITIZER "$@"
 echo '##################################################'
 ../scripts/"$CONFIGURE" -Dwerror=true $SANITIZER "$@"
 case $? in
     0)
	 echo 'Configuration succeeded'
	 ;;
     77)
	 echo 'Configuration skipped'
	 exit 0
	 ;;
     *)
	 echo 'Configuration failed with' "$?"
	 cat meson-logs/*
	 exit 1
	 ;;
 esac
 cat meson-logs/*
 ninja && meson test -t 20 -v)
case $? in
    0)
	rm -rf "$DIR"
	;;
    *)
	exit $?
	;;
esac

